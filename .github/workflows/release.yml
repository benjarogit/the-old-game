# Release: Bei Tag v* â†’ C++-Builds (Win/Mac/Linux) + GitHub Release + GitHub Pages
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git
          sudo apt-get install -y libasound2-dev libx11-dev libxrandr-dev libxi-dev
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxcursor-dev libxinerama-dev
      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      - name: Build
        run: cmake --build build --config Release
      - name: Prepare artifact
        run: |
          mkdir -p release
          cp build/spiel-des-lebens release/spiel-des-lebens-linux
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: release/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure
        run: cmake -B build -G "Visual Studio 17 2022" -A x64
      - name: Build
        run: cmake --build build --config Release
      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Force -Path release
          Copy-Item build\Release\spiel-des-lebens.exe release\spiel-des-lebens-windows.exe
      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: release/

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      - name: Build
        run: cmake --build build --config Release
      - name: Prepare artifact
        run: |
          mkdir -p release
          cp build/spiel-des-lebens release/spiel-des-lebens-macos
      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: release/

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Flatten artifacts
        run: |
          mkdir -p release
          for d in artifacts/*/; do cp -r "$d"/* release/ 2>/dev/null || true; done
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Web version
            Play in your browser: **https://benjarogit.github.io/the-old-game/**

            ## Desktop downloads
            Attached below: Windows (`.exe`), Linux, macOS.
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Prepare site
        run: |
          mkdir -p site
          cp index.html style.css game.js site/
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
